# 동파법(LOC 전용, 일일 N등분 매수) 전략 요약서

## 1) 개요
- **목표**: 레버리지 ETF(예: SOXL)에 분할·그리드가 아닌 **일일 N등분 매수(트렌치 예산)** 를 적용하고,
  **주봉 RSI(14, Wilder)** 방향으로 **모드(안전/공세)** 를 전환해 리스크/회전을 조절.
- **체결 규칙**: **모든 주문은 LOC(Limit-On-Close)**
  - **매수(LOC)**: `종가 ≤ 매수주문가` → 그날 **종가**로 **트렌치 예산 한도만큼** 1회 매수
  - **익절(LOC)**: `종가 ≥ 각 트렌치 TP` → 그날 **종가**로 청산
  - **보유기간 만료(LOC)**: 만료일 **종가**로 청산
- **중요 포인트**: **레일(여러 매수호가)** 없음. 매도가 전혀 없다면 **최대 N일**만 매수 가능.

---

## 2) 사용 종목
- **투자 종목**: SOXL(예시, 변경 가능)
- **모멘텀(주봉 RSI 계산용)**: QQQ
- **벤치마크**: SOXX (성과 비교용)

---

## 3) 모드 전환 규칙 (주봉 RSI, Wilder 14)
- 주간 RSI와 **직전 주 대비 변화(ΔRSI)** 로 판정.  
- **안전모드(하방/불안) — ΔRSI < 0** 이면서 아래 중 하나  
  - RSI ≥ 65에서 하락, 또는  
  - 40 < RSI < 50에서 하락, 또는  
  - **50선 하방 돌파**
- **공세모드(상승/반등) — ΔRSI > 0** 이면서 아래 중 하나  
  - **50선 상방 돌파**, 또는  
  - 50 < RSI < 60에서 상승, 또는  
  - RSI < 35 구간에서 상승
- 애매하면 **직전 모드 유지**.  
- **모드 변경 시** 트렌치 예산 **재계산**(기준가 리셋 없음).

---

## 4) 일일 N등분 매수(LOC) 규칙
- **분할수 N**: 가용현금(Deployable Cash)을 **N등분** → **트렌치 예산(tranche_budget)**.
- **하루 1회만 매수 시도**(체결되면 그날은 추가 매수 없음).
- **매수주문가**: *전일 종가* × (1 + **매수조건%**).  
  - 안전/공세 모드별로 **매수조건%** 설정(예: 안전 3%, 공세 5%).
  - **양수값**은 전일 종가 대비 상승 폭을 허용하고, **음수값**은 하락 시에만 체결.
- **체결**: `당일 종가 ≤ 매수주문가` 이면 **당일 종가**로 **트렌치 예산 한도**만큼 매수.
- **각 트렌치의 TP**: 체결가 × (1 + **익절%**).  
- **최대 보유기간**: 일 단위, 만료 시 종가로 청산.
- **투자금 갱신/모드 변경** 시점마다 트렌치 예산을 **다시 계산**.
- **금액 계산**: 모든 체결/현금/손익 금액은 **소수 둘째 자리(센트)** 까지 반올림해 실제 체결 단위와 일치.
- **트랜치 기록**: 매수된 각 트랜치는 하나의 행에 매수·매도 정보가 함께 남아 매매 히스토리를 즉시 확인 가능.

### 권장 기본값 (예시)
| 모드 | 분할수(N) | 매수조건(%) | 익절(%) | 최대보유(거래일) |
|---|---:|---:|---:|---:|
| 안전 | 7 | 3.0 | 0.2 | 30 |
| 공세 | 7 | 5.0 | 2.5 | 7 |

---

## 5) 투자금 갱신(복리) 규칙
- **주기(예: 10 거래일)** 마다 해당 기간 **실현손익** 집계 후 가용현금 조정:
  - 이익: `+ (주기 이익 × PCR)`  
  - 손실: `+ (주기 손실 × LCR)` *(손실은 음수이므로 일부만 반영되어 현금이 줄어듦)*
- 트렌치 예산 = `현재 가용현금 / N` (갱신 시 재계산).  
- 권장: **PCR=80%**, **LCR=30%**.
- **실현 손익 기반**: 트렌치 예산은 투자금 갱신 주기(장 개장일 기준)마다 실현 손익을 반영해 갱신되고, 계산된 새 예산은 **다음 거래일**부터 적용됨.

---

## 6) 파라미터와 옵션
- **모드별 조건 세트**: 각 모드에 대해 `매수조건%`, `익절%`, `최대 보유일`, `분할수(N)`을 정의한다. 분할수는 트렌치 예산을 정하고, 매수조건/익절은 LOC 주문가와 TP를 계산한다.
- **손절율(%)**: 모드별로 손절폭을 지정하면 체결가 대비 해당 비율만큼 하락하는 순간 종가 기준으로 즉시 LOC 청산한다. 0 이하로 두면 손절 로직이 비활성화된다.
- **투자금 갱신 설정**: `초기 가용현금`, `갱신 주기`, `PCR`, `LCR` 값으로 복리 주기를 제어한다. 주기가 도래할 때 직전 주기의 실현 손익을 PCR/LCR 비율만큼 현금에 더해 다음 사이클 트렌치 예산을 갱신한다.
- **모드 전환 시 초기화**: `reset_on_mode_change` 옵션을 켜면 모드 변경과 동시에 현재 현금 기준으로 트렌치 예산을 재산출한다. 끄면 기존 예산을 유지한 채 모드만 바뀐다.
- **슬리피지**: 엔진은 현재 슬리피지를 적용하지 않지만, `slippage_pct` 파라미터를 확장용으로 보유한다.

---

## 7) 의사코드
```text
for each trading day t:
  # 주봉 RSI 기준 모드 판정(ΔRSI 포함)
  mode = decide_mode(...)

  # 트렌치 예산 (모드 변경/자본갱신 시 재계산)
  tranche_budget = cash / N

  # LOC Buy (1일 최대 1회)
  buy_limit = prev_close * (1 + buy_cond_pct/100)
  if Close[t] <= buy_limit and cash >= tranche_budget + fee:
      qty = tranche_budget / Close[t]
      buy at Close[t]; set TP = Close[t]*(1+tp_pct)

  # LOC Sell
  for lot in lots:
      if Close[t] >= lot.TP or days>=max_hold_days:
          sell at Close[t]

  # 투자금 갱신 주기
  if day % refresh_cycle_days == 0:
      cash += max(0,cycle_pnl)*PCR + min(0,cycle_pnl)*LCR
      recompute tranche_budget

  Equity = cash + Σ(lot.qty*Close[t]); record journal
```

---

## 8) 주의 및 팁
- **레버리지 ETF**는 장기 보유 시 **볼마손실** 가능 → **최대 보유기간** 중요.
- 매수조건 기준은 기본 **전일 종가**이나, **당일 시가/고가/저가** 기준으로 바꿀 수 있음.
- 필요 시 **일일 신규 매수 최대 횟수=1** 규칙을 0~1 사이 확률, 변동성 기반 등으로 변형 가능.
