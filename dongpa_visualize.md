# 동파법 대시보드 시각화 가이드

## 1) 개요
- `backtest.py`는 Streamlit 기반 대시보드로 전략 입력값을 받고 결과를 시각화한다.
- 실행 명령: `streamlit run backtest.py`
- 다운로드된 시세는 `outputs/` 폴더에 CSV로 저장되어 재사용할 수 있다.

---

## 2) 요약 영역 구성
- **Equity Curve**: 전략의 일일 Equity 시계열을 선 그래프로 표시한다.
- **요약 지표 1행**: `Final Equity`, `Sharpe (rf=0)`, `Volatility (ann)`, `Max Drawdown`을 한 줄에 배치한다.
- **요약 지표 2행**: `모멘텀 티커 보유 수익률`, `투자 티커 보유 수익률`, `전략 누적 수익률`, `CAGR`을 출력한다. Buy&Hold 수익률은 다운로드된 시세의 첫 종가 대비 마지막 종가로 계산한다.

---

## 3) 실현 지표 카드
- 두 줄로 구성되며 `기간 내 이익률`, `거래횟수`, `MOC 횟수`, `이익금`, `평균 보유일`, `평균 이익률`, `평균 실현이익`, `평균 실현손해`를 보여준다.
- 실현 지표 블록과 일일 요약 표 사이에는 Divider를 넣어 가독성을 높였다.

---

## 4) 일일 거래 요약 컬럼
- **퉁치기 옵션**: 기본값 On. 동일 거래일에 체결된 매수·매도를 순매수/순매도로 상쇄해 `매수수량`, `매도수량`, `매수금액`, `매도금액`, `매도평균` 등에 반영한다. 원래 체결 값은 `원매수/원매도` 컬럼에서 확인할 수 있다.
- **예약요약**: 다음 거래일 장 종료 시까지 유지해야 하는 주문을 `매수 N주 @ 가격 (예산 $금액) | 매도 N주 @ TP` 형식으로 제공한다. 매도 TP는 동일 가격대를 묶어 수량을 합산한다.
- 기타 주요 컬럼: `매수조건(%)`, `매수주문가`, `매수거래ID`, `실현손익`, `Equity`, `일일트렌치예산`, `TP평균(보유)` 등.

---

## 5) 트랜치별 거래 일지
- 컬럼: `거래ID, 매수일자, 매수모드, 매수조건(%), 매수주문가, 매수체결가, 매수수량, 매수금액, TP목표가, SL목표가, 매도일자, 매도평균, 매도수량, 매도금액, 보유기간(일), 실현손익, 수익률(%), 청산사유, 상태`.
- `청산사유` 값: `TP`, `SL`, `MOC`.
- `_buy_timestamp` 내부 컬럼은 출력 직전 드롭한다.

---

## 6) 다운로드 기능
- `일일 요약 CSV`, `트랜치 로그 CSV`, `Equity CSV` 다운로드 버튼을 제공한다.
- CSV 인코딩: 일일 요약/거래 로그는 `utf-8-sig`, Equity는 `utf-8`.

---

## 7) 사용자 입력 위젯
- 사이드바 구획: 기본 설정(티커/기간) → 거래 옵션(퉁치기) → 투자금 갱신 → 안전/공세 모드 파라미터.
- 손절율 입력은 0 이하일 때 비활성화되어 SL이 적용되지 않는다.
- 모든 수치는 Streamlit `number_input`을 사용해 즉시 검증된다.
